---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import BaseFooter from '../../components/BaseFooter.astro';
import FallbackImage from '../../assets/blog-placeholder-1.jpg';
import Header from '../../components/header/index.astro';
import TastingCard from '../../components/TastingCard.astro';
import CategoryFilter from '../../components/CategoryFilter.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import { calculateReadingTime, extractFirstImage } from '../../utils/readingTime';

// Get query params for filtering
const url = new URL(Astro.request.url);
const currentCategory = url.searchParams.get('category');

const allTastings = (await getCollection('tastings'))
  .sort((a, b) => {
    const dateA = a.data.pubDate || a.data.date;
    const dateB = b.data.pubDate || b.data.date;
    return (dateB?.valueOf() || 0) - (dateA?.valueOf() || 0);
  })
  .map((tasting) => ({
    ...tasting,
    readingTime: calculateReadingTime(tasting.body),
    heroImage: tasting.data.heroImage || extractFirstImage(tasting.body),
  }));

// Filter tastings by category if specified
const tastings = currentCategory
  ? allTastings.filter((tasting) => tasting.data.category === currentCategory)
  : allTastings;

// Get all unique categories
const categories = [
  ...new Set(allTastings.map((tasting) => tasting.data.category).filter(Boolean)),
] as string[];
---

<!doctype html>
<html lang="fr">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} image={FallbackImage} />
  </head>
  <body class="bg-white">
    <Header />

    <!-- Page Header -->
    <div class="pt-32 pb-12 bg-gradient-to-b from-accent-50 to-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-accent mb-4">
          {currentCategory ? `Articles sur ${currentCategory}` : 'Toutes les dégustations'}
        </h1>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
          {
            currentCategory
              ? `Découvrez nos dégustations et voyages en ${currentCategory}`
              : 'Découvrez nos dégustations et voyages autour du whisky et des spiritueux'
          }
        </p>
        <div class="mt-4 text-sm text-gray-500">
          {tastings.length} dégustation{tastings.length > 1 ? 's' : ''}
        </div>
      </div>
    </div>

    <!-- Category Filter -->
    {
      categories.length > 0 && (
        <CategoryFilter categories={categories} currentCategory={currentCategory} />
      )
    }

    <!-- Tastings Grid -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      {
        tastings.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {tastings.map((tasting, index) => (
              <TastingCard
                title={tasting.data.title}
                slug={tasting.id}
                heroImage={tasting.heroImage}
                date={tasting.data.pubDate || tasting.data.date}
                category={tasting.data.category}
                readingTime={tasting.readingTime}
                featured={index === 0}
              />
            ))}
          </div>
        ) : (
          <div class="text-center py-12">
            <p class="text-xl text-gray-600 mb-4">
              Aucune dégustation trouvée dans cette catégorie.
            </p>
            <a href="/tastings" class="text-peat-600 hover:text-peat-700 font-medium">
              Voir toutes les dégustations →
            </a>
          </div>
        )
      }
    </main>

    <BaseFooter />
  </body>
</html>
