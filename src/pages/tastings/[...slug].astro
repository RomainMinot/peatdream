---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import TastingPost from '../../layouts/TastingPost.astro';
import { calculateReadingTime, extractFirstImage } from '../../utils/readingTime';

export async function getStaticPaths() {
  const tastings = await getCollection('tastings');

  return tastings.map((tasting) => {
    // Get previous and next tastings (sorted by date)
    const sortedTastings = [...tastings].sort((a, b) => {
      const dateA = a.data.pubDate || a.data.date;
      const dateB = b.data.pubDate || b.data.date;
      return (dateB?.valueOf() || 0) - (dateA?.valueOf() || 0);
    });

    const currentIndex = sortedTastings.findIndex((t) => t.id === tasting.id);
    const prev =
      currentIndex < sortedTastings.length - 1 ? sortedTastings[currentIndex + 1] : undefined;
    const next = currentIndex > 0 ? sortedTastings[currentIndex - 1] : undefined;

    return {
      params: { slug: tasting.id },
      props: { tasting, prev, next },
    };
  });
}

type Props = {
  tasting: CollectionEntry<'tastings'>;
  prev?: CollectionEntry<'tastings'>;
  next?: CollectionEntry<'tastings'>;
};

const { tasting, prev, next } = Astro.props;
const { Content, headings } = await render(tasting);

// Calculate reading time from raw body
const readingTime = calculateReadingTime(tasting.body);

// Try to get hero image from frontmatter or extract from content
const heroImage = tasting.data.heroImage || extractFirstImage(tasting.body);
---

<TastingPost
  {...tasting.data}
  headings={headings}
  prev={prev}
  next={next}
  readingTime={readingTime}
  heroImage={heroImage}>
  <Content />
</TastingPost>
