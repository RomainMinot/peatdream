---
interface Props {
  categories: string[];
  currentCategory?: string | null;
}

const { categories, currentCategory } = Astro.props;

// Count posts per category
const categoryCounts = categories.reduce(
  (acc, cat) => {
    if (cat) {
      acc[cat] = (acc[cat] || 0) + 1;
    }
    return acc;
  },
  {} as Record<string, number>,
);

const uniqueCategories = Object.keys(categoryCounts).sort();
---

<div class="w-full bg-accent-50 border-y border-accent-200 py-6 mb-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-accent">Filtrer par r√©gion</h2>
      {
        currentCategory && (
          <a
            href="/tastings"
            id="clear-filter"
            class="text-sm text-peat-600 hover:text-peat-700 font-medium flex items-center gap-1 transition-colors">
            <span>Effacer le filtre</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </a>
        )
      }
    </div>
    <div class="flex flex-wrap gap-3" id="category-filters">
      <a
        href="/tastings"
        data-category="all"
        class={`px-4 py-2 rounded-full transition-all inline-flex items-center gap-2 ${
          !currentCategory
            ? 'bg-peat-500 text-white font-semibold shadow-sm'
            : 'bg-white text-gray-700 hover:bg-accent-100 border border-accent-200 hover:border-peat-300'
        }`}>
        <span>Tous</span>
        <span class="text-xs opacity-75">({categories.length})</span>
      </a>
      {
        uniqueCategories.map((category) => (
          <a
            href={`/tastings?category=${encodeURIComponent(category)}`}
            data-category={category}
            class={`px-4 py-2 rounded-full transition-all inline-flex items-center gap-2 ${
              currentCategory === category
                ? 'bg-peat-500 text-white font-semibold shadow-sm'
                : 'bg-white text-gray-700 hover:bg-accent-100 border border-accent-200 hover:border-peat-300'
            }`}>
            <span>{category}</span>
            <span class="text-xs opacity-75">({categoryCounts[category]})</span>
          </a>
        ))
      }
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const categoryLinks = document.querySelectorAll('#category-filters a');
    const clearFilterBtn = document.getElementById('clear-filter');

    // Ensure correct visual state on page load based on URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentCategoryFromUrl = urlParams.get('category');
    
    categoryLinks.forEach((link) => {
      const linkCategory = (link as HTMLElement).getAttribute('data-category');
      const shouldBeActive = 
        (currentCategoryFromUrl === null && linkCategory === 'all') ||
        (currentCategoryFromUrl === linkCategory);
      
      if (shouldBeActive) {
        link.classList.remove(
          'bg-white',
          'text-gray-700',
          'hover:bg-accent-100',
          'border',
          'border-accent-200',
          'hover:border-peat-300',
        );
        link.classList.add('bg-peat-500', 'text-white', 'font-semibold', 'shadow-sm');
      } else {
        link.classList.remove('bg-peat-500', 'text-white', 'font-semibold', 'shadow-sm');
        link.classList.add(
          'bg-white',
          'text-gray-700',
          'hover:bg-accent-100',
          'border',
          'border-accent-200',
          'hover:border-peat-300',
        );
      }
    });

    // Handle category filter clicks
    categoryLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();

        const category = (link as HTMLElement).getAttribute('data-category');
        if (!category) return;

        // Update active state
        categoryLinks.forEach((l) => {
          l.classList.remove('bg-peat-500', 'text-white', 'font-semibold', 'shadow-sm');
          l.classList.add(
            'bg-white',
            'text-gray-700',
            'hover:bg-accent-100',
            'border',
            'border-accent-200',
            'hover:border-peat-300',
          );
        });

        link.classList.remove(
          'bg-white',
          'text-gray-700',
          'hover:bg-accent-100',
          'border',
          'border-accent-200',
          'hover:border-peat-300',
        );
        link.classList.add('bg-peat-500', 'text-white', 'font-semibold', 'shadow-sm');

        // Filter tastings
        if ((window as any).filterTastings) {
          (window as any).filterTastings(category);
        }

        // Update URL without reloading
        const newUrl =
          category === 'all' ? '/tastings' : `/tastings?category=${encodeURIComponent(category)}`;
        window.history.pushState({}, '', newUrl);
      });
    });

    // Handle clear filter button
    if (clearFilterBtn) {
      clearFilterBtn.addEventListener('click', (e) => {
        e.preventDefault();

        // Reset to "all"
        categoryLinks.forEach((l) => {
          const cat = (l as HTMLElement).getAttribute('data-category');
          l.classList.remove('bg-peat-500', 'text-white', 'font-semibold', 'shadow-sm');
          l.classList.add(
            'bg-white',
            'text-gray-700',
            'hover:bg-accent-100',
            'border',
            'border-accent-200',
            'hover:border-peat-300',
          );

          if (cat === 'all') {
            l.classList.remove(
              'bg-white',
              'text-gray-700',
              'hover:bg-accent-100',
              'border',
              'border-accent-200',
              'hover:border-peat-300',
            );
            l.classList.add('bg-peat-500', 'text-white', 'font-semibold', 'shadow-sm');
          }
        });

        if ((window as any).filterTastings) {
          (window as any).filterTastings('all');
        }

        window.history.pushState({}, '', '/tastings');
      });
    }
  });
</script>
