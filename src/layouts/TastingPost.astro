---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import BaseFooter from '../components/BaseFooter.astro';
import Header from '../components/header/index.astro';
import TastingHero from '../components/TastingHero.astro';
import TastingContent from '../components/TastingContent.astro';
import TableOfContents from '../components/TableOfContents.astro';
import TastingNavigation from '../components/TastingNavigation.astro';
import FallbackImage from '../assets/blog-placeholder-1.jpg';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  title: string;
  description?: string;
  pubDate?: Date;
  date?: Date;
  updatedDate?: Date;
  heroImage?: any;
  category?: string;
  headings?: Heading[];
  prev?: CollectionEntry<'tastings'>;
  next?: CollectionEntry<'tastings'>;
  readingTime?: number;
}

const {
  title,
  description,
  pubDate,
  date,
  updatedDate,
  heroImage,
  category,
  headings = [],
  prev,
  next,
  readingTime,
} = Astro.props;

const displayDate = pubDate || date;
const displayHeroImage = heroImage || FallbackImage;
---

<!doctype html>
<html lang="fr">
  <head>
    <BaseHead title={title} description={description ?? ''} image={displayHeroImage} />
    <style is:global>
      @import '../styles/global.css';
    </style>
  </head>
  <body class="bg-white">
    <Header />

    <!-- Hero Section -->
    <TastingHero
      title={title}
      date={displayDate}
      category={category}
      heroImage={displayHeroImage}
      readingTime={readingTime}
    />

    <!-- Main Content -->
    <div class="relative">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-1 xl:grid-cols-[1fr_250px] gap-12">
          <!-- Article Content -->
          <article class="min-w-0">
            <div class="max-w-[65ch] mx-auto xl:mx-0">
              {
                updatedDate && (
                  <div class="mb-8 p-4 bg-accent-50 border-l-4 border-peat rounded">
                    <p class="text-sm text-gray-600">
                      <span class="font-semibold">Mis Ã  jour le :</span>{' '}
                      {updatedDate.toLocaleDateString('fr-FR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })}
                    </p>
                  </div>
                )
              }

              <TastingContent>
                <slot />
              </TastingContent>

              <!-- Tasting Navigation -->
              <div class="mt-16">
                <TastingNavigation prev={prev} next={next} />
              </div>
            </div>
          </article>

          <!-- Table of Contents (Desktop only) -->
          <TableOfContents headings={headings} />
        </div>
      </div>
    </div>

    <BaseFooter />

    <script>
      // Synchronize back button and TOC position with header visibility
      document.addEventListener('DOMContentLoaded', () => {
        const backButton = document.getElementById('back-button');
        const tocNav = document.getElementById('toc-nav');

        if (!backButton && !tocNav) return;

        let lastScrollY = window.scrollY;
        let ticking = false;
        let isHeaderHidden = false;

        const updatePositions = () => {
          const currentScrollY = window.scrollY;

          // Determine if header should be hidden (same logic as header component)
          let shouldHideHeader = false;

          if (currentScrollY < 100) {
            shouldHideHeader = false; // Always show when at top
          } else if (currentScrollY > lastScrollY && currentScrollY > 100) {
            shouldHideHeader = true; // Hide when scrolling down after 100px
          } else if (currentScrollY < lastScrollY) {
            shouldHideHeader = false; // Show when scrolling up
          }

          // Only update if state changed
          if (shouldHideHeader !== isHeaderHidden) {
            isHeaderHidden = shouldHideHeader;

            if (isHeaderHidden) {
              // Header is hidden, move elements up
              // Check if small screen or larger
              const isSmallScreen = window.innerWidth < 640;

              if (backButton) {
                backButton.style.top = isSmallScreen ? '1rem' : '1.5rem'; // top-4 or top-6
              }
              if (tocNav) {
                tocNav.style.top = '2rem'; // top-8
              }
            } else {
              // Header is visible, restore original position
              if (backButton) {
                backButton.style.top = ''; // Reset to original top-24/sm:top-28
              }
              if (tocNav) {
                tocNav.style.top = ''; // Reset to original top-28
              }
            }
          }

          lastScrollY = currentScrollY;
          ticking = false;
        };

        const requestUpdate = () => {
          if (!ticking) {
            window.requestAnimationFrame(updatePositions);
            ticking = true;
          }
        };

        window.addEventListener('scroll', requestUpdate, { passive: true });

        // Handle window resize to update positions
        window.addEventListener(
          'resize',
          () => {
            if (isHeaderHidden && backButton) {
              const isSmallScreen = window.innerWidth < 640;
              backButton.style.top = isSmallScreen ? '1rem' : '1.5rem';
            }
          },
          { passive: true },
        );
      });
    </script>
  </body>
</html>

<style>
  /* Smooth scroll for anchor links */
  html {
    scroll-behavior: smooth;
  }

  /* Add scroll margin for anchor links to account for fixed header */
  :global(h2),
  :global(h3),
  :global(h4) {
    scroll-margin-top: 6rem;
  }
</style>
